<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservations Calendar Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      margin: 0 0 12px 0;
      color: #1a1a1a;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    .legend {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .dot {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .airbnb { background: #FF5A5F; }
    .booking { background: #003580; }
    .calendar-wrapper {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #calendar { min-height: 600px; }
    .fc-event-title { font-weight: 500; }
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 13px;
      color: #666;
    }
    .footer a { color: #206bc4; text-decoration: none; }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      text-align: center;
      padding: 40px;
      color: #d9534f;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè† Reservations Dashboard</h1>
      <p class="subtitle">Combined view of blocked dates from Airbnb + Booking.com</p>
      <div class="legend">
        <div class="legend-item">
          <div class="dot airbnb"></div>
          <span>Airbnb</span>
        </div>
        <div class="legend-item">
          <div class="dot booking"></div>
          <span>Booking.com</span>
        </div>
      </div>
    </header>

    <div class="calendar-wrapper">
      <div id="loading" class="loading">Loading calendar...</div>
      <div id="calendar" style="display: none;"></div>
      <div id="error" class="error" style="display: none;">
        Failed to load calendar. <a href="./calendar.ics">Download ICS file</a>
      </div>
    </div>

    <div class="footer">
      <a href="./calendar.ics">üìÖ Download ICS Feed</a> for your calendar app
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/icalendar@6.1.15/index.global.min.js"></script>
  <script>
    function parseICS(icsText) {
      const events = [];
      const lines = icsText.replace(/\r\n/g, '\n').split('\n');
      let currentEvent = null;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        if (line === 'BEGIN:VEVENT') {
          currentEvent = {};
        } else if (line === 'END:VEVENT' && currentEvent) {
          events.push(currentEvent);
          currentEvent = null;
        } else if (currentEvent) {
          if (line.startsWith('UID:')) {
            currentEvent.uid = line.slice(4);
            // Detect platform from UID
            if (currentEvent.uid.includes('@airbnb.com')) {
              currentEvent.platform = 'airbnb';
              currentEvent.color = '#FF5A5F';
            } else if (currentEvent.uid.includes('@booking.com')) {
              currentEvent.platform = 'booking';
              currentEvent.color = '#003580';
            }
          } else if (line.startsWith('DTSTART')) {
            const dateMatch = line.match(/(\d{4})(\d{2})(\d{2})/);
            if (dateMatch) {
              currentEvent.start = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;
            }
          } else if (line.startsWith('DTEND')) {
            const dateMatch = line.match(/(\d{4})(\d{2})(\d{2})/);
            if (dateMatch) {
              // For display, we use exclusive end dates (ICS DTEND is exclusive)
              const end = new Date(parseInt(dateMatch[1]), parseInt(dateMatch[2]) - 1, parseInt(dateMatch[3]));
              end.setDate(end.getDate() - 1);
              currentEvent.end = end.toISOString().split('T')[0];
            }
          } else if (line.startsWith('SUMMARY:')) {
            currentEvent.title = line.slice(8) || 'Blocked';
          }
        }
      }
      
      return events;
    }

    async function initCalendar() {
      try {
        const response = await fetch('./calendar.ics');
        if (!response.ok) throw new Error('Failed to fetch ICS');
        
        const icsText = await response.text();
        const events = parseICS(icsText);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('calendar').style.display = 'block';

        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
          },
          events: events.map(e => ({
            ...e,
            display: 'background',
            allDay: true
          })),
          eventClick: function(info) {
            const source = info.event.extendedProps.platform === 'airbnb' ? 'Airbnb' : 'Booking.com';
            alert(`${source} reservation\nCheck-in: ${info.event.start.toLocaleDateString()}\nCheck-out: ${info.event.end ? new Date(info.event.end.getTime() + 86400000).toLocaleDateString() : 'N/A'}`);
          }
        });

        calendar.render();
      } catch (err) {
        console.error(err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    initCalendar();
  </script>
</body>
</html>
